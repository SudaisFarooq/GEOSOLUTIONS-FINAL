<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flood Prediction</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Flatpickr CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:Arial,Helvetica,sans-serif;
      background:#001322;
      color:#eef;
      text-align:center;
      line-height:1.6;
      scroll-behavior:smooth;
    }
    h1 {
      margin-top:30px;
      font-size:32px;
      color:#00c6ff;
      text-shadow:0 0 15px #0099ff;
      animation:glowPulse 2s infinite alternate;
    }
    form {
      background:rgba(255,255,255,0.05);
      padding:20px;
      margin:40px auto;
      width:90%;
      max-width:600px;
      border-radius:15px;
      box-shadow:0 6px 20px rgba(0,0,0,0.6);
      backdrop-filter:blur(6px);
    }
    label { display:block; margin:15px 0 5px; font-weight:bold; color:#88d; }
    input[type="text"] {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #046;
      background:#012;
      color:#fff;
    }
    button {
      margin-top:15px;
      background:#00aaff;
      border:none;
      padding:12px 20px;
      border-radius:10px;
      color:#fff;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(0,0,0,0.5);
      transition:all 0.3s ease;
    }
    button:hover { background:#00ccff; transform:scale(1.05); }

    #map {
      height: 300px;
      width: 90%;
      margin: 20px auto;
      border-radius: 10px;
      border: 2px solid #046;
    }

    #chartContainer {
      margin:40px auto;
      width:90%;
      max-width:800px;
      background:rgba(255,255,255,0.05);
      border-radius:15px;
      padding:20px;
      box-shadow:0 6px 20px rgba(0,0,0,0.6);
      display:none;
    }

    @keyframes glowPulse {
      from { text-shadow:0 0 8px #00c6ff, 0 0 16px #0099ff; }
      to { text-shadow:0 0 20px #00ffff, 0 0 30px #00c6ff; }
    }
  </style>
</head>
<body>
  <h1>Flood Prediction</h1>

  <form id="predictForm">
    <label for="dateRange">Select Date Range:</label>
    <input type="text" id="dateRange" placeholder="Select start and end dates" required>

    <label for="map">Select Your Location:</label>
    <div id="map"></div>
    <input type="hidden" id="latitude" required>
    <input type="hidden" id="longitude" required>

    <button type="submit">Get Prediction</button>
  </form>

  <div id="chartContainer">
    <canvas id="predictionChart"></canvas>
  </div>

  <script>
    // Initialize flatpickr for range selection
    flatpickr("#dateRange", {
      mode: "range",
      dateFormat: "Y-m-d",
      minDate: "2024-01-01",
      maxDate: "2025-12-31"
    });

    // Initialize Leaflet map
    const map = L.map('map').setView([29.05, 79.48], 8); // default to Udham Singh Nagar
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lng;
    });

    const form = document.getElementById('predictForm');
    const chartContainer = document.getElementById('chartContainer');
    let predictionChart = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const dateRange = document.getElementById('dateRange').value;
      if (!dateRange) return alert("Please select a date range");
      const [startDate, endDate] = dateRange.split(" to ");
      if (!startDate || !endDate) return alert("Please select both start and end dates");

      const latitude = document.getElementById('latitude').value;
      const longitude = document.getElementById('longitude').value;
      if (!latitude || !longitude) return alert("Please select your location on the map");

      try {
        const response = await fetch('https://geosolutions-final.vercel.app/api/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ startDate, endDate, latitude, longitude })
        });

        const data = await response.json();
        if (!data.prediction) throw new Error("Invalid response format");

        renderChart(data.prediction.date, data.prediction.percentage);
      } catch (err) {
        console.error(err);
        alert("Error fetching prediction data. Check console for details.");
      }
    });

    function renderChart(dates, percentages) {
      chartContainer.style.display = "block";

      if (predictionChart) predictionChart.destroy();

      const ctx = document.getElementById('predictionChart').getContext('2d');
      predictionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Flood Probability (%)',
            data: percentages,
            borderColor: '#00ccff',
            backgroundColor: 'rgba(0, 204, 255, 0.2)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            tension: 0.4,
          }]
        },
        options: {
          scales: {
            x: { ticks: { color: '#88d' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            y: { ticks: { color: '#88d' }, grid: { color: 'rgba(255,255,255,0.1)' } }
          },
          plugins: {
            legend: { labels: { color: '#fff' } },
            tooltip: {
              backgroundColor: '#012',
              titleColor: '#00ccff',
              bodyColor: '#fff'
            }
          },
          animation: { duration: 1000, easing: 'easeInOutQuart' }
        }
      });
    }
  </script>
</body>
</html>
